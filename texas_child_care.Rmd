---
title: "texas_child_care"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(lubridate)
```

```{r child_care_data}
# from https://data.texas.gov/Social-Services/HHSC-CCL-Daycare-and-Residential-Operations-Data/bc5r-88dy
child_care <- read.csv('child_care_licenses.csv')

# from https://www.hhs.texas.gov/about-hhs/records-statistics/data-statistics/child-care-licensing-statistics
child_care_2021_01 <- read.csv('child_care_operations_2021_01.csv')
child_care_2021_02 <- read.csv('child_care_operations_2021_02.csv')
child_care_2021_02 <- child_care_2021_02 %>% 
  unique()
child_care_2021_03 <- read.csv('child_care_operations_2021_03.csv')
child_care_2021_04 <- read.csv('child_care_operations_2021_04.csv')
child_care_2021_05 <- read.csv('child_care_operations_2021_05.csv')
child_care_2021_06 <- read.csv('child_care_operations_2021_06.csv')
child_care_2021_06$Operation.Region <- as.character(child_care_2021_06$Operation.Region)
child_care_2021_07 <- read.csv('child_care_operations_2021_07.csv')
child_care_2021_08 <- read.csv('child_care_operations_2021_08.csv')

# county level from https://censusreporter.org/data/table/?table=B09001&geo_ids=04000US48,050|04000US48&primary_geo_id=04000US48#
# zip code level from https://censusreporter.org/data/table/?table=B09001&geo_ids=04000US48,050|04000US48,860|04000US48&primary_geo_id=04000US48#
children_by_county <- read.csv('children_county.csv')
children_by_zip <- read.csv('children_zip.csv')
```

```{r child_care_cleaning}
child_care <- child_care %>% 
  mutate(ISSUANCE_DATE = mdy(ISSUANCE_DATE))

child_care_permits_2021 <- child_care_2021_01 %>% 
  pivot_longer(cols = starts_with('Permit.Status.'), names_to = 'Week', names_prefix = 'Permit.Status.', 
               values_to = 'Status') %>% 
  select(1:11, Week, Status) %>% 
  bind_rows(., child_care_2021_02 %>% 
              pivot_longer(cols = starts_with('Permit.Status.'), names_to = 'Week', 
                           names_prefix = 'Permit.Status.', values_to = 'Status') %>% 
              select(1:11, Week, Status), child_care_2021_03 %>% 
              pivot_longer(cols = starts_with('Permit.Status.'), names_to = 'Week', 
                           names_prefix = 'Permit.Status.', values_to = 'Status') %>% 
              select(1:11, Week, Status), child_care_2021_04 %>% 
              pivot_longer(cols = starts_with('Permit.Status.'), names_to = 'Week', 
                           names_prefix = 'Permit.Status.', values_to = 'Status') %>% 
              select(1:11, Week, Status), child_care_2021_05 %>% 
              pivot_longer(cols = starts_with('Permit.Status.'), names_to = 'Week', 
                           names_prefix = 'Permit.Status.', values_to = 'Status') %>% 
              select(1:11, Week, Status), child_care_2021_06 %>% 
              pivot_longer(cols = starts_with('Permit.Status.'), names_to = 'Week', 
                           names_prefix = 'Permit.Status.', values_to = 'Status') %>% 
              select(1:11, Week, Status), child_care_2021_07 %>% 
              pivot_longer(cols = starts_with('Permit.Status.'), names_to = 'Week', 
                           names_prefix = 'Permit.Status.', values_to = 'Status') %>% 
              select(1:11, Week, Status), child_care_2021_08 %>% 
              pivot_longer(cols = starts_with('Permit.Status.'), names_to = 'Week', 
                           names_prefix = 'Permit.Status.', values_to = 'Status') %>% 
              select(1:11, Week, Status)) %>% 
  mutate(Permit.Issue.Date = as.Date(parse_date_time(Permit.Issue.Date, '%m/%d/%y')), 
         Week = as.Date(parse_date_time(Week, '%m.%d.%Y')))

child_care_operations_2021 <- child_care_2021_01 %>% 
  pivot_longer(cols = starts_with('Operating.Status.'), names_to = 'Week', names_prefix = 'Operating.Status.', 
               values_to = 'Status') %>% 
  select(1:11, Week, Status) %>% 
  bind_rows(., child_care_2021_02 %>% 
              pivot_longer(cols = starts_with('Operating.Status.'), names_to = 'Week', 
                           names_prefix = 'Operating.Status.', values_to = 'Status') %>% 
              select(1:11, Week, Status), child_care_2021_03 %>% 
              pivot_longer(cols = starts_with('Operating.Status.'), names_to = 'Week', 
                           names_prefix = 'Operating.Status.', values_to = 'Status') %>% 
              select(1:11, Week, Status), child_care_2021_04 %>% 
              pivot_longer(cols = starts_with('Operating.Status.'), names_to = 'Week', 
                           names_prefix = 'Operating.Status.', values_to = 'Status') %>% 
              select(1:11, Week, Status), child_care_2021_05 %>% 
              pivot_longer(cols = starts_with('Operating.Status.'), names_to = 'Week', 
                           names_prefix = 'Operating.Status.', values_to = 'Status') %>% 
              select(1:11, Week, Status), child_care_2021_06 %>% 
              pivot_longer(cols = starts_with('Operating.Status.'), names_to = 'Week', 
                           names_prefix = 'Operating.Status.', values_to = 'Status') %>% 
              select(1:11, Week, Status), child_care_2021_07 %>% 
              pivot_longer(cols = starts_with('Operating.Status.'), names_to = 'Week', 
                           names_prefix = 'Operating.Status.', values_to = 'Status') %>% 
              select(1:11, Week, Status), child_care_2021_08 %>% 
              pivot_longer(cols = starts_with('Operating.Status.'), names_to = 'Week', 
                           names_prefix = 'Operating.Status.', values_to = 'Status') %>% 
              select(1:11, Week, Status)) %>% 
  mutate(Permit.Issue.Date = as.Date(parse_date_time(Permit.Issue.Date, '%m/%d/%y')), 
         Week = as.Date(parse_date_time(Week, '%m.%d.%Y')))
```

```{r child_care_checks}
# check missingness of data from month to month
child_care_operations_2021 %>% 
  group_by(Week) %>% 
  count(Status) %>% 
  mutate(pct_n = n / sum(n) * 100) %>% 
  filter(day(Week) == 1)

# find centers in operations status data, but not licensing data
child_care_operations_2021 %>% 
  filter(Week == as.Date('2021-08-01')) %>% 
  mutate(Operation.Number = gsub('-|- | ', '', Operation.Number)) %>% 
  anti_join(., child_care %>% 
              mutate(OPERATION_NUMBER = gsub('-|- | ', '', OPERATION_NUMBER)),
            by = c('Operation.Number' = 'OPERATION_NUMBER')) %>% 
  filter(Status == 'N', County %in% deserts, Capacity > 0) %>% 
  arrange(desc(Capacity)) %>% 
  select(Operation.Name, Address.Line.1, City, County, Operation.Type, Capacity)

# find centers in licensing data, but not operations status data
child_care %>% 
  mutate(OPERATION_NUMBER = gsub('-|- | ', '', OPERATION_NUMBER)) %>% 
  anti_join(., child_care_operations_2021 %>% 
              filter(Week == as.Date('2021-08-01')) %>% 
              mutate(Operation.Number = gsub('-|- | ', '', Operation.Number)),
            by = c('OPERATION_NUMBER' = 'Operation.Number'))

child_care_operations_2021 %>% 
  filter(Week == as.Date('2021-08-01')) %>% 
  count(Operation.Type)

child_care %>% 
  count(OPERATION_TYPE)
```

```{r child_care_licenses_analysis}
# count number of licenses issued from 1983 to 2021 (through Sept. 27)
child_care %>% 
  count(year(ISSUANCE_DATE), month(ISSUANCE_DATE)) %>% 
  arrange(n)

# count number of licenses issued in each county in 2019, 2020, 2021
child_care %>% 
  group_by(year(ISSUANCE_DATE), COUNTY) %>% 
  filter(year(ISSUANCE_DATE) %in% c(2019, 2020, 2021), !is.na(COUNTY), COUNTY != '') %>% 
  count(COUNTY) %>% 
  arrange(COUNTY) %>% 
  pivot_wider(names_from = COUNTY, values_from = n)

# count number of licenses issued in each county
child_care %>% 
  count(COUNTY) %>% 
  arrange(desc(n))

# count number of potential closures in each county
child_care_operations_2021 %>%
  filter(Week == as.Date('2021-08-01')) %>% 
  mutate(Operation.Number = gsub('-|- | ', '', Operation.Number)) %>% 
  anti_join(., child_care %>% 
              mutate(OPERATION_NUMBER = gsub('-|- | ', '', OPERATION_NUMBER)),
            by = c('Operation.Number' = 'OPERATION_NUMBER')) %>% 
  group_by(County) %>% 
  count(Status) %>% 
  filter(County != '') %>% 
  mutate(pct_closed = n / sum(n) * 100) %>% 
  filter(Status == 'N') %>% 
  arrange(desc(n))
```

```{r child_care_operations_analysis}
# count number of centers "not caring" statewide per week from January 2021 to August 2021
child_care_operations_2021 %>% 
  group_by(Week) %>% 
  count(Status) %>% 
  mutate(pct_no = n / sum(n) * 100) %>% 
  filter(Status == 'N') %>% 
  filter(day(Week) == 1)

# count number of centers "not caring" per county per week
child_care_operations_2021 %>% 
  group_by(Week, County) %>% 
  count(Status) %>% 
  mutate(pct_no = n / sum(n) * 100) %>% 
  filter(Status == 'N') %>%
  filter(day(Week) == 1) %>% 
  arrange(desc(Week), desc(pct_no), desc(n))

# count types of centers "not caring" as of August 2021 and calculate their median capacity
child_care_operations_2021 %>% 
  filter(Status == 'N', Week == as.Date('2021-08-01')) %>% 
  group_by(Operation.Type) %>% 
  summarize(Capacity = median(Capacity, na.rm = T)) %>% 
  bind_cols(., child_care_operations_2021 %>% 
              filter(Status == 'N', Week == as.Date('2021-08-01')) %>% 
              count(Operation.Type) %>% 
              select(n)) %>% 
  ungroup() %>% 
  mutate(pct = n / sum(n) * 100)

# count number of non-unique centers "not caring"
child_care_operations_2021 %>% 
  filter(Status == 'N') %>% 
  count(Operation.Number) %>% 
  filter(n > 2) %>% 
  left_join(., child_care_operations_2021 %>% 
              filter(Status == 'N'))

# calculate ratio of children under 5 to total capacity of centers, by county
child_care %>% 
  summarize(TOTAL_CAPACITY = sum(TOTAL_CAPACITY, na.rm = T)) %>% 
  merge(., children_by_county %>% 
          filter(county == 'Texas')) %>% 
  summarize(under_5 = under_3_years + X3_to_4_years + X5_years, TOTAL_CAPACITY, ratio = under_5 / TOTAL_CAPACITY)

child_care %>% 
  group_by(COUNTY) %>% 
  summarize(TOTAL_CAPACITY = sum(TOTAL_CAPACITY, na.rm = T)) %>% 
  merge(., children_by_county %>% 
          filter(county != 'Texas') %>% 
          mutate(county = toupper(county)) %>% 
          rename(COUNTY = county)) %>% 
  summarize(COUNTY, under_5 = under_3_years + X3_to_4_years + X5_years,
            TOTAL_CAPACITY, ratio = under_5 / TOTAL_CAPACITY) %>% 
  arrange(desc(ratio))

# calculate ratio of children under 5 to total capacity of centers open as of August 1, 2021, by county
child_care_operations_2021 %>% 
  filter(Week == as.Date('2021-08-01'), Status == 'Y', County != '') %>% 
  group_by(County) %>% 
  summarize(Capacity = sum(Capacity, na.rm = T)) %>% 
  merge(., children_by_county %>% 
          filter(county != 'Texas') %>% 
          mutate(county = toupper(county)) %>% 
          rename(County = county)) %>% 
  summarize(County, under_5 = under_3_years + X3_to_4_years + X5_years, Capacity, ratio = under_5 / Capacity) %>% 
  arrange(desc(ratio))
```

```{r child_care_output}
# to export spreadsheets of centers "not caring"
multiple_not_caring_2021 <- child_care_operations_2021 %>% 
  filter(Status == 'N') %>% 
  count(Operation.Number) %>% 
  filter(n > 2) %>% 
  left_join(., child_care, by = c('Operation.Number' = 'OPERATION_NUMBER')) %>% 
  left_join(., child_care_operations_2021, by = 'Operation.Number') %>% 
  mutate(Address = paste0(Address.Line.1, ', ', City, ', TX ', Zip.Code)) %>% 
  select(Operation.Name, Address, Week, Status, Operation.Type, Capacity, ADMINISTRATOR_DIRECTOR_NAME, PHONE_NUMBER, 
         email_address, WEBSITE_ADDRESS, Permit.Issue.Date, PROGRAMS_PROVIDED, LICENSED_TO_SERVE_AGES) %>% 
  filter(Status == 'N')

not_caring_2021 <- child_care_operations_2021 %>% 
  filter(Status == 'N', Operation.Name != '#NAME?') %>% 
  left_join(., child_care, by = c('Operation.Number' = 'OPERATION_NUMBER')) %>% 
  mutate(Address = paste0(Address.Line.1, ', ', City, ', TX ', Zip.Code)) %>% 
  select(Operation.Name, Address, Week, Operation.Type, Capacity, ADMINISTRATOR_DIRECTOR_NAME, PHONE_NUMBER, 
         email_address, WEBSITE_ADDRESS, Permit.Issue.Date, PROGRAMS_PROVIDED, LICENSED_TO_SERVE_AGES)

# to export spreadsheet of potentially closed center
potentially_closed <- child_care_operations_2021 %>% 
  filter(Week == as.Date('2021-08-01')) %>% 
  mutate(Operation.Number = gsub('-|- | ', '', Operation.Number)) %>% 
  anti_join(., child_care %>% 
              mutate(OPERATION_NUMBER = gsub('-|- | ', '', OPERATION_NUMBER)),
            by = c('Operation.Number' = 'OPERATION_NUMBER')) %>% 
  filter(Status == 'N') %>% 
  left_join(., child_care, by = c('Operation.Number' = 'OPERATION_NUMBER')) %>% 
  mutate(Address = paste0(Address.Line.1, ', ', City, ', TX ', Zip.Code)) %>% 
  select(Operation.Name, Address, Operation.Type, Capacity, Permit.Issue.Date)
```

```{r child_care_viz}
# visualize number of child care licenses issued from 1983 to 2021 (through Sept. 27)
child_care %>% 
  count(year(ISSUANCE_DATE), month(ISSUANCE_DATE)) %>% 
  summarize(date = mdy(paste0(as.character(`month(ISSUANCE_DATE)`), '/01/', `year(ISSUANCE_DATE)`)), n) %>% 
  ggplot(data = ., mapping = aes(x = date, y = n)) +
  geom_line() +
  theme_classic()

# visualize number of centers "not caring" from January 2021 to August 2021
child_care_operations_2021 %>% 
  filter(day(Week) == 1) %>% 
  group_by(Week) %>% 
  count(Status) %>% 
  filter(Status == 'N') %>% 
  ggplot(data = ., mapping = aes(x = Week, y = n)) +
  geom_line()
```

```{r wage_data}
# from https://www.bls.gov/oes/tables.htm
oes_2020 <- read.csv('oes_2020.csv')
oes_2019 <- read.csv('oes_2019.csv')
oes_2018 <- read.csv('oes_2018.csv')
oes_2017 <- read.csv('oes_2017.csv')
oes_2016 <- read.csv('oes_2016.csv')
oes_2015 <- read.csv('oes_2015.csv')
oes_2014 <- read.csv('oes_2014.csv')
oes_2013 <- read.csv('oes_2013.csv')
oes_2012 <- read.csv('oes_2012.csv')
oes_2011 <- read.csv('oes_2011.csv')
```

```{r wage_cleaning}
# filter for Texas and metropolitan statistical areas in Texas, as well as childcare workers
# 25-2011: preschool teachers, except special education
# 25-2012: kindergarten Teachers, except special education
# 35-3011: bartenders
# 35-3023: fast food and counter workers
# 35-3031: waiters and waitresses
# 39-9011: child care workers
# 41-2031: retail salespersons

oes_2020 <- oes_2020 %>% 
  filter(PRIM_STATE == 'TX', 
         OCC_CODE %in% c('25-2011', '25-2012', '35-3011', '35-3023', '35-3031', '39-9011', '41-2031')) %>% 
  select(-PRIM_STATE, -I_GROUP) %>% 
  mutate(year = 2020)

oes_2019 <- oes_2019 %>% 
  filter(area %in% oes_2020$AREA, occ_code %in% oes_2020$OCC_CODE) %>% 
  rename(jobs_1000 = jobs_1000_orig) %>% 
  select(-i_group) %>% 
  mutate(year = 2019)

colnames(oes_2020) <- colnames(oes_2019)

oes_2018 <- oes_2018 %>% 
  filter(area %in% oes_2020$area, occ_code %in% oes_2020$occ_code) %>% 
  select(-X, -i_group) %>% 
  mutate(year = 2018)

oes_2017 <- oes_2017 %>% 
  filter(area %in% oes_2020$area, occ_code %in% oes_2020$occ_code) %>% 
  select(-X, -i_group) %>% 
  mutate(year = 2017)

oes_2016 <- oes_2016 %>% 
  filter(area %in% oes_2020$area, occ.code %in% oes_2020$occ_code) %>% 
  select(-X) %>% 
  mutate(year = 2016)

oes_2015 <- oes_2015 %>% 
  filter(area %in% oes_2020$area, occ.code %in% oes_2020$occ_code) %>% 
  select(-X) %>% 
  mutate(year = 2015)

oes_2014 <- oes_2014 %>% 
  filter(area %in% oes_2020$area, occ.code %in% oes_2020$occ_code) %>% 
  mutate(year = 2014)

oes_2013 <- oes_2013 %>% 
  filter(area %in% oes_2020$area, occ_code %in% oes_2020$occ_code) %>% 
  mutate(year = 2013)

oes_2012 <- oes_2012 %>% 
  filter(area %in% oes_2020$area, occ_code %in% oes_2020$occ_code) %>% 
  mutate(year = 2012)

oes_2011 <- oes_2011 %>% 
  filter(AREA %in% oes_2020$area, OCC_CODE %in% oes_2020$occ_code) %>% 
  mutate(year = 2011)

colnames(oes_2016) <- colnames(oes_2020)
colnames(oes_2015) <- colnames(oes_2020)
colnames(oes_2014) <- colnames(oes_2020)
colnames(oes_2011) <- colnames(oes_2020)
oes_2019$loc_quotient <- as.character(oes_2019$loc_quotient)

all <- bind_rows(oes_2011, oes_2012, oes_2013, oes_2014, oes_2015,
          oes_2016, oes_2017, oes_2018, oes_2019, oes_2020) %>% 
  mutate(naics = as.integer(naics), h_mean = as.double(h_mean), a_mean = as.double(gsub(',', '', a_mean)), 
         mean_prse = as.double(mean_prse), h_pct10 = as.double(h_pct10), h_pct25 = as.double(h_pct25), 
         h_median = as.double(h_median), h_pct75 = as.double(h_pct75), a_pct10 = as.double(gsub(',', '', a_pct10)), 
         a_pct25 = as.double(gsub(',', '', a_pct25)), a_median = as.double(gsub(',', '', a_median)), 
         a_pct75 = as.double(gsub(',', '', a_pct75)), a_pct90 = as.double(gsub(',', '', a_pct90)))
```

```{r wage_analysis}
# calculate change in median hourly wage for child care workers in each MSA from 2011 to 2020
all %>% 
  filter(occ_code == '39-9011') %>% 
  select(year, area, h_median) %>% 
  filter(year == 2011 | year == 2020) %>% 
  pivot_wider(names_from = year, values_from = h_median) %>% 
  mutate(change = `2020` - `2011`) %>% 
  arrange(area) %>% 
  bind_cols(., all %>% 
              filter(occ_code == '39-9011') %>% 
              arrange(year) %>% 
              slice(1:32) %>%
              select(area_title)) %>% 
  arrange(desc(change))

# compare median hourly wage for each job in each MSA in 2020
all %>% 
  filter(area != 48) %>% 
  select(year, area, occ_title, a_median) %>% 
  mutate(hourly_median = a_median / (40 * 52)) %>% 
  select(-a_median) %>% 
  filter(year == 2020) %>% 
  left_join(., all %>% 
              filter(area != 48) %>% 
              arrange(year) %>% 
              slice(1:179) %>% 
              select(area, area_title) %>% 
              unique()) %>% 
  select(area_title, occ_title, hourly_median) %>% 
  group_by(area_title) %>% 
  arrange(desc(hourly_median), .by_group = T) %>% 
  filter(occ_title %in% c('Retail Salespersons', 'Childcare Workers', 
                          'Preschool Teachers, Except Special Education',
                          'Kindergarten Teachers, Except Special Education'))

all %>% 
  filter(area == 47020, year == 2020) %>% 
  select(occ_title, h_median)

# calculate change in median hourly wage for each job in each MSA from 2011 to 2020
all %>% 
  filter(area != 48) %>% 
  select(year, area, occ_title, a_median) %>% 
  mutate(hourly_median = a_median / (40 * 52)) %>% 
  select(-a_median) %>% 
  filter(year == 2011 | year == 2020) %>% 
  pivot_wider(names_from = year, values_from = hourly_median) %>% 
  mutate(change = `2020` - `2011`) %>% 
  left_join(., all %>% 
              filter(area != 48) %>% 
              arrange(year) %>% 
              slice(1:179) %>% 
              select(area, area_title) %>% 
              unique()) %>% 
  select(area_title, occ_title, change) %>% 
  group_by(area_title) %>% 
  arrange(desc(change), .by_group = T) %>% 
  filter(occ_title %in% c('Retail Salespersons', 'Childcare Workers'))

# calculate change in median hourly wage for each job statewide from 2011 to 2020
all %>% 
  filter(area == 48) %>% 
  select(year, occ_title, a_median) %>% 
  mutate(hourly_median = a_median / (40 * 52)) %>% 
  select(-a_median) %>% 
  pivot_wider(names_from = occ_title, values_from = hourly_median) %>% 
  select(-8)
```

```{r wage_viz}
# visualize median hourly wage for childcare workers from 2011 to 2020
all %>% 
  filter(area == 48, occ_code == '39-9011') %>% 
  ggplot(data = ., mapping = aes(x = year, y = h_median)) +
  geom_line() +
  scale_x_discrete(limits = c(2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020)) +
  scale_y_continuous(limits = c(7.25, 15)) +
  labs(y = 'median hourly wage for child care workers') +
  theme_classic()
```